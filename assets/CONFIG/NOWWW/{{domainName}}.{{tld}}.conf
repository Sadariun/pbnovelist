<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    ServerName {{canonicalDomain}}
    ServerAlias www.{{canonicalDomain}}

    DocumentRoot /var/www/{{canonicalDomain}}
    <Directory /var/www/{{canonicalDomain}}/>
        Options FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    RewriteEngine On

# ПРАВИЛО 1: Если страница НЕ СУЩЕСТВУЕТ, сразу отправляем на каноническую главную.
# Это правило ловит все запросы к несуществующим страницам (с www, без www, http, https)
# и немедленно делает ОДИН редирект на https://{{canonicalDomain}}/.
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . https://{{canonicalDomain}}/ [L,R=301]

# ПРАВИЛО 2: Канонизация для СУЩЕСТВУЮЩИХ страниц.
# Это правило сработает, ТОЛЬКО если файл/папка существуют.
# Если используется http или www, делаем ОДИН редирект на канонический URL, сохраняя путь.
RewriteCond %{HTTP_HOST} !^hospitalangeleschihuahua\.mx$ [NC,OR]
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://{{canonicalDomain}}$1 [L,R=301]

RewriteCond %{SERVER_NAME} =www.{{canonicalDomain}} [OR]
RewriteCond %{SERVER_NAME} ={{canonicalDomain}}
RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>
